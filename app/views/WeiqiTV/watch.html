#{extends 'main.html' /}
#{set title: channel.title /}
#{set page: channel.title /}
#{set note:'WeiqiTV - Watching Weiqi like on TV (Î±-Status)' /}

#{zapper channels: channels, actual: channel.number /}

%{
game = channel.game;
size = game.size.getLength();
}%

<script type="text/javascript">

function viewPrisoners (move) {
  var prisoners = move.prisoners;
  if(prisoners != undefined && prisoners.length) {
    var color = move.player.toLowerCase();
    $.each(prisoners, function(key, val) {
      $('#' + val.coordinate).removeClass('white black').addClass('empty').empty();
      var dl = $('#' + color + "Prisoners");
      var dt = $('#' + color + "PrisonerCount");
      var count = parseInt(dt.text());
//       alert(move.number + " " + move.player + " " + val.coordinate + " " + count);
      if(count == 0) {
        dl.append('<dd class="first"></dd>');
      } else {
        dl.append('<dd></dd>');
      }
      dt.text(count + 1);
    });
  }
}

$(document).ready(function() {
  // create event socket callback
  var display = function(event) {
    $('#commentList').append('<li class="igs">' + event + '</li>');
    eval("e = " + event);
    switch(e.type) {
      case "move":
        var player = e.player.toLowerCase();
        $("#" + e.coordinate).removeClass('empty black white ko')
          .addClass(player).empty().append(e.number);
        $('#' + player + "Time").empty().append(e.time);
        viewPrisoners(e);
        break;
      case "message":
        $('#result').empty().append(e.message).css('visibility','visible');
        break;
      default:
        alert("unknown socket event " + event)
        break;
    }
  }

  // create web socket
  var socket = new WebSocket('@@{ChannelSocket.stream(channel.number)}');
  socket.onmessage = function(event) { display(event.data); }

  // initialize board
  var listAction = #{jsAction @listTurns(':game') /}
  $.getJSON(listAction({game: '${game.id}'}), function(data) {
    $.each(data, function(key, val) {
//       eval("val = " + data);
      var player = val.player.toLowerCase();
      // set actual move
      $("#" + val.coordinate).removeClass('empty').addClass(player);
      // blank prisoners
      viewPrisoners(val);
    });
  });
});

</script>

<!--Channel-->
<div id="channel">

<table>
<caption>${game} ${game.size}</caption>
#{board/head size /}
#{list items: (size == 19 ? 19..1 : (size == 13 ? 13..1 : 9..1)), as:'nr'}
<tr class="${nr_isFirst ? 'first' : (nr_isLast ? 'last' : '')}">
  <th>${nr}</th>
  <td class="${nr_isFirst ? 'blanktl' : (nr_isLast ? 'blankbl' : 'blankl')}">
    <div id="A${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="B${nr}" class="empty"></div>
  </td>
  <td class="${size == 9 && (nr == 3 || nr == 7) ? 'hoshi' : 'blank'}">
    <div id="C${nr}" class="empty"></div>
  </td>
  <td class="${size != 9 && (nr == 4 || nr == 10 || nr == 16) ? 'hoshi' : 'blank'}">
    <div id="D${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="E${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="F${nr}" class="empty"></div>
  </td>
  <td class="${((size == 9 && (nr == 3 || nr == 7)) || (size == 13 && nr == 7)) ? 'hoshi' : 'blank'}">
    <div id="G${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="H${nr}" class="empty"></div>
  </td>
#{if size == 9}
  <td class="${nr_isFirst ? 'blanktr' : (nr_isLast ? 'blankbr' : 'blankr')}">
    <div id="J${nr}" class="empty"></div>
  </td>
#{/if}
#{if size > 9}
  <td class="blank">
    <div id="J${nr}" class="empty"></div>
  </td>
  <td class="${nr == 4 || nr == 10 || nr == 16 ? 'hoshi' : 'blank'}">
    <div id="K${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="L${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="M${nr}" class="empty"></div>
  </td>
#{if size == 13}
  <td class="${nr_isFirst ? 'blanktr' : (nr_isLast ? 'blankbr' : 'blankr')}">
    <div id="N${nr}" class="empty"></div>
  </td>
#{/if}
#{if size > 13}
  <td class="blank">
    <div id="N${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="O${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="P${nr}" class="empty"></div>
  </td>
  <td class="${nr == 4 || nr == 10 || nr == 16 ? 'hoshi' : 'blank'}">
    <div id="Q${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="R${nr}" class="empty"></div>
  </td>
  <td class="blank">
    <div id="S${nr}" class="empty"></div>
  </td>
#{/if}
#{if size == 19}
  <td class="${nr_isFirst ? 'blanktr' : (nr_isLast ? 'blankbr' : 'blankr')}">
    <div id="T${nr}" class="empty"></div>
  </td>
#{/if}
#{/if}
  <th>${nr}</th>
</tr>
#{/list}
#{board/head size /}
</table>

<!--Game result-->
<div id="result">
<p>$player wins!<br />
$results</p>
</div>
<!--/Game result-->

</div>
<!--/Channel-->

<!--Channeldata-->
<div id="channeldata">

<!--Data-->
<div id="data">

<!--Data for White-->

<div id="white">
<h3>${channel.game.white}</h3>
<ul>
 <li id="whiteTime">0</li>
 <li><dl id="whitePrisoners"><dt  id="whitePrisonerCount">0</dt></dl></li>
</ul>
</div>
<!--/Data for White-->

<!--Data for Black-->
<div id="black">
<h3>${channel.game.black}</h3>
<ul>
 <li id="blackTime">0</li>
 <li><dl id="blackPrisoners"><dt id="blackPrisonerCount">0</dt></dl></li>
</ul>
</div>
<!--/Data for Black-->

<p>
Komi: ${game.komi}<br />
Byo: $byo<br />
frei / gewertet<br />
<a href="@@{Admin.observe(channel.number, game.onlineId)}">game: ${game.onlineId}</a>
</p>
</div>
<!--/Data-->

<!--Admin-->
<div id="admin">
<h3>Admin panel</h3>
<div id="panel">
<ul>
 <li><a href="">Play</a></li>
 <li><a href="">Pause</a></li>
 <li><a href="@@{Admin.next(channel.number)}">Next Game</a></li>
</ul>
</div>
</div>
<!--/Admin-->

<!--Chat-->
<div id="chat">
<h3>Game comments</h3>
<div id="comments">
<ul id="commentList">
 <li class="igs">1. Text vom IGS-User</li>
 <li class="igs">2. Text vom IGS-User</li>
 <li class="wqtv">1. Text vom WeiqiTV-User</li>
 <li class="igs">3. Text vom IGS-User</li>
 <li class="wqtv">2. Text vom WeiqiTV-User</li>
 <li class="wqtv">3. Text vom WeiqiTV-User</li>
 <li class="igs">4. Text vom IGS-User</li>
 <li class="wqtv">4. Text vom WeiqiTV-User</li>
 <li class="wqtv">5. Text vom WeiqiTV-User</li>
 <li class="igs">5. Text vom IGS-User</li>
</ul>
</div>
<form action="" method="get" enctype="text/plain" accept-charset="ISO-8859-1">
<fieldset>
 <p><label for="input">Your Comment:</label>
    <textarea id="input" name="input" rows="1" cols="30"></textarea></p>
</fieldset>
</form>
</div>

<!--/Chat-->

</div>
<!--/Channeldata-->
